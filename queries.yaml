id: queries
type: PageHeaderMenu
public: true
properties:
  title: Queries
  content:
    style:
      background: '#f5f5f5'
layout:
  contentGutter: 16
requests:
  - id: fetch_open_queries
    type: MongoDBAggregation
    connectionId: queries
    properties:
      pipeline:
        - $match:
            status:
              $ne: Closed
        - $project:
            _id: 1
            name: 1
            company: 1
            status: 1
            flagged: 1
            created_date: 1
            created_user.name: 1
        - $sort:
            flagged: -1
            created_date: 1
  - id: fetch_selected
    type: MongoDBAggregation
    connectionId: queries
    properties:
      pipeline:
        - $match:
            _id:
              _state: selected_id
        - $project:
            status: 1
            company: 1
            flagged: 1
            query_description: 1
            history:
              $reverseArray: $history

mutations:
  - id: set_flagged
    type: MongoDBUpdateOne
    connectionId: queries
    properties:
      filter:
        _id:
          _state: selected_id
      update:
        - $set:
            updated_date:
              _date: now
            flagged:
              _not:
                _state: selected.flagged
            history:
              $concatArrays:
                - $history
                - - action:
                      _if:
                        test:
                          _eq:
                            - _state: selected.flagged
                            - true
                        then: Removed flag
                        else: Flagged
                    status: $status
                    timestamp:
                      _date: now
                    user:
                      name:
                        _user: name
                      id:
                        _user: id
  - id: close_query
    type: MongoDBUpdateOne
    connectionId: queries
    properties:
      filter:
        _id:
          _state: selected_id
      update:
        - $set:
            updated_date:
              _date: now
            status: Closed
            history:
              $concatArrays:
                - $history
                - - action: Closed query
                    status: Closed
                    timestamp:
                      _date: now
                    user:
                      name:
                        _user: name
                      id:
                        _user: id
  - id: change_status_on_query
    type: MongoDBUpdateOne
    connectionId: queries
    properties:
      filter:
        _id:
          _state: selected_id
      update:
        - $set:
            updated_date:
              _date: now
            status:
              _state: selected.change_status_selector
            history:
              $concatArrays:
                - $history
                - - action: Changed Status
                    status:
                      _state: selected.change_status_selector
                    comment:
                      _state: selected.change_status_comment
                    timestamp:
                      _date: now
                    user:
                      name:
                        _user: name
                      id:
                        _user: id

  - id: comment_on_query
    type: MongoDBUpdateOne
    connectionId: queries
    properties:
      filter:
        _id:
          _state: selected_id
      update:
        - $set:
            updated_date:
              _date: now
            history:
              $concatArrays:
                - $history
                - - action: Commented
                    status: $status
                    comment:
                      _state: selected.comment_input
                    timestamp:
                      _date: now
                    user:
                      name:
                        _user: name
                      id:
                        _user: id

actions:
  onInit:
    - id: fetch
      type: Fetch
      params:
        - fetch_open_queries
    - id: init
      type: SetState
      params:
        open_list:
          _request: fetch_open_queries
blocks:
  - id: list_box
    type: Box
    layout:
      span: 14
    blocks:
      - id: open_title
        type: Markdown
        properties:
          content: "###### Open"
      - id: open_card
        type: Card
        style:
          marginTop: 4
        blocks:
          - id: open_list
            type: List
            blocks:
              - id: open_list.$.box
                type: Box
                actions:
                  onClick:
                    - id: set_selected_id
                      type: SetState
                      params:
                        selected_id:
                          _state: open_list.$._id
                    - id: fetch_selected
                      type: Fetch
                      params:
                        - fetch_selected
                    - id: set_selected
                      type: SetState
                      params:
                        selected:
                          _get:
                            key: '0'
                            from:
                              _request: fetch_selected
                blocks:
                  - id: open_list.$.status
                    type: Badge
                    properties:
                      color:
                        _get:
                          from:
                            _global: statusColors
                          key:
                            _state: open_list.$.status
                      text:
                        _state: open_list.$.status
                  - id: open_list.$.title
                    type: Markdown
                    properties:
                      content:
                        _nunjucks:
                          template: |
                            ##### {{ company }}

                            created: {{ created_date | date("D MMMM YYYY HH:mm") }} {{ created_user.name }}

                            flagged: {{ flagged }}
                          on:
                            _state: open_list.$
                  - id: open_list.$.description
                    type: Markdown
                    style:
                      '.markdown-body':
                        fontSize: 14
                    properties:
                      content:
                        _nunjucks:
                          template: |
                            {{ name }}
                          on:
                            _state: open_list.$
                  - id: open_list.$.divider
                    type: Divider
                    visible:
                      _not:
                        _eq:
                          - _state: open_list.$._id
                          - _mql_expr:
                              $arrayElemAt:
                                - $open_list._id
                                - -1
  - id: selected_box
    type: Box
    layout:
      span: 10
    blocks:
      - id: selected.title
        type: Markdown
        properties:
          content: "###### Selected"
      - id: selected.card
        type: Card
        style:
          marginTop: 4
        blocks:
          - id: selected.non_selected
            type: Result
            visible:
              _not:
                _mql_test:
                  selected._id:
                    $exists: true
            properties:
              icon:
                name: ContainerTwoTone
                color: '#bfbfbf'
              subTitle: No query selected
          - id: selected.visible_box
            type: Box
            visible:
              _mql_test:
                selected._id:
                  $exists: true
            layout:
              contentGutter: 16
            blocks:
              - id: selected.status
                type: Icon
                layout:
                  flex: 0 1 auto
                properties:
                  size: 32
                  color:
                    _get:
                      from:
                        _global: statusColors
                      key:
                        _state: selected.status
                  name:
                    _get:
                      from:
                        _global: statusIcons
                      key:
                        _state: selected.status
              - id: selected.title
                type: Markdown
                layout:
                  flex: 1 1 auto
                style:
                  marginTop: 8
                properties:
                  content:
                    _nunjucks:
                      template: |
                        ### {{ company }}
                      on:
                        _state: selected
              - id: selected.flag
                type: Icon
                layout:
                  flex: 0 1 auto
                properties:
                  size: 32
                  name: FlagTwoTone
                  color:
                    _if:
                      test:
                        _eq:
                          - _state: selected.flagged
                          - true
                      then: '#f5222d'
                      else: '#bfbfbf'

                actions:
                  onClick:
                    - id: set_flagged
                      type: Mutate
                      params: set_flagged
                    - id: fetch
                      type: Fetch
                    - id: set_state
                      type: SetState
                      params:
                        selected:
                          _get:
                            key: '0'
                            from:
                              _request: fetch_selected
                        open_list:
                          _request: fetch_open_queries
              - id: selected.actions_box
                type: Box
                layout:
                  contentGutter: 8
                blocks:
                  - id: selected.change_status_button
                    type: Button
                    layout:
                      flex: 1 1 auto
                    properties:
                      title: Change Status
                      block: true
                      type: default
                      icon: RetweetOutlined
                    actions:
                      onClick:
                        - id: open_change_status_modal
                          type: CallMethod
                          params:
                            blockId: selected.change_status_modal
                            method: toggleOpen
                  - id: selected.comment_button
                    type: Button
                    layout:
                      flex: 1 1 auto
                    properties:
                      title: Comment
                      block: true
                      type: default
                      icon: MessageOutlined
                    actions:
                      onClick:
                        - id: open_comment_modal
                          type: CallMethod
                          params:
                            blockId: selected.comment_modal
                            method: toggleOpen
                  - id: selected.escalate_button
                    type: Button
                    layout:
                      flex: 1 1 auto
                    properties:
                      title: Escalate
                      block: true
                      type: default
                      icon: ExclamationCircleOutlined
                  - id: selected.close_button
                    type: Button
                    layout:
                      flex: 1 1 auto
                    properties:
                      title: Close
                      block: true
                      type: default
                      icon: StopOutlined
                    actions:
                      onClick:
                        - id: open_confirm_close_modal
                          type: CallMethod
                          params:
                            blockId: selected.confirm_close_modal
                            method: toggleOpen

              - id: selected.description
                type: Markdown
                style:
                  '.markdown-body':
                    fontSize: 14
                properties:
                  content:
                    _nunjucks:
                      template: |
                        {{ query_description }}
                      on:
                        _state: selected
              - id: selected.history
                type: Timeline
                properties:
                  data:
                    _mql_aggregate:
                      pipeline:
                        - $addFields:
                            icons:
                              $objectToArray:
                                _global: actionIcons
                            colors:
                              $objectToArray:
                                _global: actionColors
                        - $project:
                            icon:
                              name:
                                $arrayElemAt:
                                  - $icons.v
                                  - $indexOfArray:
                                      - $icons.k
                                      - $action
                              color:
                                $arrayElemAt:
                                  - $colors.v
                                  - $indexOfArray:
                                      - $colors.k
                                      - $action
                      on:
                        _state: selected.history

                blocks:
                  - id: selected.history.$.description
                    type: Html
                    style:
                      fontSize: 12
                    properties:
                      html:
                        _nunjucks:
                          template: |
                            <h3> {{ action }} </h3>
                            <p style="font-size: 10px;" ><i>{{ timestamp | date("D MMMM YYYY HH:mm") }} {{ user.name }}</i></p>
                            <p>{{ comment }}</p>
                          on:
                            _state: selected.history.$

  - id: selected.change_status_modal
    type: Modal
    properties:
      okText: Change Status
    actions:
      onOk:
        - id: validate
          type: Validate
          errorMessage: A status is required.
          params: selected.change_status_selector
        - id: change_status_on_query
          type: Mutate
          params: change_status_on_query
        - id: fetch
          type: Fetch
        - id: set_state
          type: SetState
          params:
            selected:
              _get:
                key: '0'
                from:
                  _request: fetch_selected
            open_list:
              _request: fetch_open_queries
    blocks:
      - id: selected.comment_modal_title
        type: Markdown
        style:
          marginBottom: 16px
        properties:
          content: "#### Change Status"
      - id: selected.change_status_selector
        type: Selector
        required: true
        properties:
          title: New Status
          options:
            _global: statuses
      - id: selected.change_status_comment
        type: TextArea
        properties:
          title: comment


  - id: selected.comment_modal
    type: Modal
    properties:
      okText: Save
    actions:
      onOk:
        - id: validate
          type: Validate
          errorMessage: A comment is required.
          params: selected.comment_input
        - id: comment_on_query
          type: Mutate
          params: comment_on_query
        - id: fetch
          type: Fetch
        - id: set_state
          type: SetState
          params:
            selected:
              _get:
                key: '0'
                from:
                  _request: fetch_selected
            open_list:
              _request: fetch_open_queries
    blocks:
      - id: selected.comment_modal_title
        type: Markdown
        style:
          marginBottom: 16px
        properties:
          content: "#### Comment"
      - id: selected.comment_input
        type: TextArea
        required: true
        properties:
          label:
            disabled: true

  - id: selected.confirm_close_modal
    type: Modal
    properties:
      okButtonProps:
        danger: true
      okText: Close
    actions:
      onOk:
        - id: close_query
          type: Mutate
          params: close_query
        - id: reset_selected
          type: SetState
          params:
            selected_id: null
            selected: {}
        - id: fetch
          type: Fetch
        - id: set_queries
          type: SetState
          params:
            open_list:
              _request: fetch_open_queries
    blocks:
      - id: selected.confirm_close_modal_text
        type: Markdown
        properties:
          content: "#### Are you sure you want to close this issue?"
